(function(a){function B(){var b=a("#yith-stripe-connect-card-number"),c=a("#yith-stripe-connect-card-expiry"),d=a("#yith-stripe-connect-card-cvc");if(b.length){var e=b.attr("placeholder");"undefined"!=typeof k&&k.destroy();k=x.create("cardNumber",{style:y,placeholder:e});b.replaceWith('<div id="yith-stripe-card-number" class="yith-stripe-elements-field">');k.mount("#yith-stripe-card-number")}c.length&&(e=c.attr("placeholder"),"undefined"!=typeof g&&g.destroy(),g=x.create("cardExpiry",{style:y,placeholder:e}),
    c.replaceWith('<div id="yith-stripe-card-expiry" class="yith-stripe-elements-field">'),g.mount("#yith-stripe-card-expiry"));d.length&&(e=d.attr("placeholder"),"undefined"!=typeof f&&f.destroy(),f=x.create("cardCvc",{style:y,placeholder:e}),d.replaceWith('<div id="yith-stripe-card-cvc" class="yith-stripe-elements-field">'),f.mount("#yith-stripe-card-cvc"))}function C(b){if(a("input#payment_method_yith-stripe-connect").is(":checked")&&0===a("input.stripe-connect-intent").length){var c=a("form.checkout, form#order_review, form#add_payment_method"),
    d=a("#wc-yith-stripe-connect-cc-form, #yith-stripe-connect-cc-form"),e=a(".woocommerce-checkout-payment, .woocommerce-checkout-review-order-table, #add_payment_method");b=a(".wc-credit-card-form-card-name");b=b.length?b.val():a("#billing_first_name").val()+" "+a("#billing_last_name").val();var F=a("#billing_email").val(),l=a("#billing_country"),h=l.val(),v=a("#billing_city:visible"),p=v.val(),m=a("#billing_address_1:visible"),r=m.val(),t=a("#billing_address_2:visible").val(),n=a("select#billing_state, input#billing_state:visible"),
    z=n.val(),u=a('input[name="wc-yith-stripe-connect-payment-token"]:checked');u=u.length&&"new"!==u.val()?u.val():!1;e.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var g=!1,f=[];if(l.closest("p.form-row.validate-required").length&&l.length&&""===h||v.closest("p.form-row.validate-required").length&&v.length&&""===p||m.closest("p.form-row.validate-required").length&&m.length&&""===r||n.closest("p.form-row.validate-required").length&&n.length&&""===z)g=!0,f.push("billing.fields"),""===
h&&l.parents("p.form-row").addClass("error"),""===p&&v.parents("p.form-row").addClass("error"),""===r&&m.parents("p.form-row").addClass("error"),""===z&&n.parents("p.form-row").addClass("error");g?(q({error:{code:"validation",fieldErrors:f}}),a("fieldset#wc-yith-stripe-connect-cc-form input, fieldset#wc-yith-stripe-connect-cc-form select, fieldset#yith-stripe-connect-cc-form input, fieldset#yith-stripe-connect-cc-form select").one("keydown",function(){a(this).closest("p.form-row.error").removeClass("error")}),
    a(document).trigger("yith-stripe-connect-card-error")):u?(d.append('<input type="hidden" class="stripe-connect-intent" name="stripe_connect_intent" value=""/>'),e.unblock(),c.submit()):(b=A({billing_details:{name:b,address:{line1:r,line2:t,city:p,state:z,country:h},email:F}}),w.createPaymentMethod("card",k,b).then(function(a){a.error?q(a):(d.append('<input type="hidden" class="stripe-connect-intent" name="stripe_connect_intent" value=""/>'),d.append('<input type="hidden" class="stripe-connect-payment-method" name="stripe_connect_payment_method" value="'+
    a.paymentMethod.id+'"/>'),e.unblock(),c.submit())}));return!1}return b}function G(b){if(a("input#payment_method_yith-stripe-connect").is(":checked")&&0===a("input.stripe-connect-intent").length){var c=a("#wc-yith-stripe-connect-cc-form, #yith-stripe-connect-cc-form"),d=a("form#add_payment_method"),e=a("#add_payment_method");b=a(".wc-credit-card-form-card-name");var g=a("#billing_email"),l=a("#billing_country"),h=a("#billing_city:visible"),f=a("#billing_address_1:visible"),p=a("#billing_address_2:visible"),
    m=a("select#billing_state:visible, input#billing_state:visible"),r=A({payment_method_data:{billing_details:{name:b.length?b.val():a("#billing_first_name").val()+" "+a("#billing_last_name").val(),address:{line1:f.length?f.val():"",line2:p.length?p.val():"",city:h.length?h.val():"",state:m.length?m.val():"",country:l.length?l.val():""},email:g.length?g.val():""}},save_payment_method:!0}),t,n;e.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});H().then(function(a){if("undefined"!=typeof a.res&&
    !a.res&&"undefined"!=typeof a.error)return q(a),!1;t=a.intent_id;n=a.intent_secret;w.handleCardSetup(n,k,r).then(function(a){a.error?q(a):(t="undefined"!=typeof a.paymentIntent?a.paymentIntent.id:a.setupIntent.id,c.append('<input type="hidden" class="stripe-connect-intent" name="stripe_connect_intent" value="'+t+'"/>'),e.unblock(),d.submit())})});return!1}return b}function I(){var a=window.location.hash.match(/^#?yith-stripe-connect-confirm-pi-([^:]+):(.+)$/);if(a&&!(3>a.length)){var c=a[1];a=decodeURIComponent(a[2]);
    window.location.hash="";J(c,a)}}function J(b,c){a("form.checkout, form#order_review");var d=0>b.indexOf("seti")?"handleCardAction":"handleCardSetup";w[d](b).then(function(a){a.error?q(a):window.location=c})["catch"](function(a){console.log(a)})}function q(b){var c=a("form.checkout, form#order_review, form#add_payment_method"),d=a("#wc-yith-stripe-connect-cc-form, #yith-stripe-connect-cc-form"),e=a(".woocommerce-checkout-payment, .woocommerce-checkout-review-order-table, #add_payment_method");if(b.error){a(".woocommerce-error, .stripe-token",
    d).remove();if(b.error.message)d.prepend('<ul class="woocommerce-error">'+b.error.message+"</ul>");else if("validation"===b.error.code){b=b.error.fieldErrors;for(var g=b.length,f="",h=0;h<g;h++)f+="<li>"+yith_stripe_connect_info[b[h]]+"</li>";d.prepend('<ul class="woocommerce-error">'+f+"</ul>")}a("html, body").animate({scrollTop:a(".woocommerce-error",d).offset().top})}c.removeClass("processing").unblock();e.unblock()}function D(){a(".stripe-connect-intent").remove()}function H(b){var c=[];yith_stripe_connect_info.is_checkout&&
!yith_stripe_connect_info.order&&(c=a("form.checkout").serializeArray());return a.ajax({data:K(c,{action:"yith_stripe_connect_refresh_intent",yith_stripe_connect_refresh_intent:yith_stripe_connect_info.refresh_intent,selected_token:b,is_checkout:yith_stripe_connect_info.is_checkout,order:yith_stripe_connect_info.order}),method:"POST",url:yith_stripe_connect_info.ajaxurl})}function A(b){var c={},d,e;if("object"!=typeof b)return b;for(d in b)b.hasOwnProperty(d)&&(e="object"==typeof b[d]?A(b[d]):b[d])&&
!a.isEmptyObject(e)&&(c[d]=e);return c}function K(a,c){for(var b in c)c.hasOwnProperty(b)&&a.push({name:b,value:c[b]});return a}var E=a("body"),y={base:{fontSize:"16px",color:"#333"}},w=Stripe(yith_stripe_connect_info.public_key),x=w.elements(),k,g,f;a(document).ready(function(){B();"undefined"!=typeof k&&k.addEventListener("change",q);a("form.checkout").on("checkout_place_order_yith-stripe-connect",C);a("form#order_review").on("submit",C);a("form#add_payment_method").on("submit",G);window.addEventListener("hashchange",
    I);E.on("checkout_error",D);E.on("updated_checkout",B);a("form.checkout, form#order_review, form#add_payment_method").on("change","#wc-yith-stripe-connect-cc-form input, #yith-stripe-connect-cc-form input",D)})})(jQuery);